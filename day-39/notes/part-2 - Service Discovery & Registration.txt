=========================================================
Service Discovery & Service Registration in Microservices
=========================================================

in a normal scenario - our 3 services (accounts, loans, cards) are being accessed by different clients (C1, C2, C3 etc)

but in a microservices scenario - 3 microservices will be placed in a microservice network and the external client can access it with external network using a single entry point to the microservice network and is known as Gateway / API Gateway/ Edge , which is capable of doing any checks related to (1) security (2) auditing (3) logging - all type of non-functional requirements can be performed at this single entry point

this single entry point is responsible to accept the external traffic 

sometimes one microservice may be dependent on the other microservice - like an external request comes to our accounts microservice through the API Gateway - now , in order to send the response to external application - my accounts microservice has to connect to loans microservice and cards microservice - this communication is termed as Internal communication. 

what ever communication is happening inside our microservice network is known as Internal communication

what are the challenges that we may face while our microservice trying to communicate with each other inside our microservice network

CHALLENGES

1) How do services locate each other microservices inside a network?
 - each instance of a microservice exposes a remote API with it's own host and port, how do other microservices & clients know about these dynamic endpoint URLs to invoke them. 

2) How do new service instances enter into the network?
 - scaling scenario - a new instance
 - if a microservice instance fails, new instances will be brought online to ensure constant availability. This means that the IP addresses of the instances can be constantly changing. So how does these new instances can start serving to the clients?

3) Load Balance, Info sharing between Microservices instances
 - How do we make sure to properly load balance between the multiple microservice instances especially a microservice is invoking another microservice? How do a specific service information shared across the network?

These challenges in microservices can be solved using below concept or solutions
1) Service Registry
3) Service Registration
3) Load Balancing

=====================================================
Service Discovery & Registration inside microservices
=====================================================

whenever we develop cloud native application or microservice based applications, service discovery pattern is a perfect solutions.

service discovery pattern involves tracking and storing information about all running service instances in a service registry.

the purpose of service registry is - when a new instance is created, it should be registered in the registry, and whenever it gets terminated/ shutdown then it should be appropriately removed from the registry automatically

suppose if we started 5 instances of our accounts microservices - all of them needs to be registered inside the service registry and using the same registry my loans microservice can try to discover the accounts microservice related information.


How our microservice can register themselves to a service registry, and at the same time how my other microservices like loans microservice try to discover the details of service using the service registry?

apart from service registry and service discovery the next challenge that we have is - "Load Balancing" - Load Balancing challenge is also addressed by this pattern

the service registry where it is going to maintain all the running instances - it acknowledges that multiple instances of the same application can be active simultaneously.  When a microservice want to communicate with a backing microservice, it performs a lookup in the registry to determine the IP address to connect to.
If multiple instances of a microservice is available, then behind the scene it is also going to perform the load-balancing strategy - using this eventually distribute the workload among the running instances of the microservice  

-> client-side service discovery 
-> server-side service discovery

How to solve the problem for cloud native applications?

Inside microservices network or cloud native applications we know that the IP addresses will be dynamically changing because we may change the number of instances whenever we want to perform autoscaling or in the scenarios of instance failures.

In these kind of dynamic situations  - microservices patterns like service discovery and registrations is a way for application and microservices to locate each other on a network.

What are the components involved in this pattern?
-> A central server (or servers) that maintain a global view of addresses - just like we have config server which is responsible to maintain all the configurations at a centralized location; similarly we create a central server which maintains the details of all the running service instances

How it is going to maintain is 
-> whenever a particular microservice instance is trying to get started at the very first time - it is the responsibility of the microservice itself to connect to the central server and to register their address when they start and ready - with that the central server will maintain the details in a service registry - 

-> once the microservice is started my central server also expects a regular heartbeats from my individual microservices confirming about their health

-> microservice that connect to the central server to deregister their address when they are about to shutdown

Summary: Service discovery & registrations deals with the problems about how microservices talk to each other ie perform API calls.


----------- How client side service discovery & Load Balancing Works ----------------

Service registry is in the same microservice network
Loans microservices -2 instances -- send regular heartbeat signals of their health to service registry

Accounts Microservice is the client microservice

Accounts microservice will forward the request to one of the loans microservice instance; based on its own load balancing strategy


----------- Spring Cloud support for Service Discovery & Registration ----------------

How can we implement client side service discovery inside our microservices network - Spring Cloud
Spring Cloud support for Client-side service discovery



https://spring.io > Projects > Spring Cloud > Spring Cloud Netflix - eureka server, spring cloud load balancer etc
	> Spring Cloud Open Feign - used for microservices communication - to communicate with other RESTAPIs like RestTemplate, WebClient etc


Netflix - is an OTT Platform  (Over-The-Top)
histroy in integration of name Netflix with Spring Boot - 
https://netflixtechblog.com/netflix-oss-and-spring-boot-coming-full-circle-4855947713a0


======== SUMARY ============
-> Service Registry is used to maintain all APIs information like name, status, url and health at one place
-> It is also called as Service Discovery
-> We can use "Eureka Server" as service registry
-> Eureka Service is provided by "Spring Cloud" library
-> It will provide user interface to get APIs info
-> CONSUL is an alternative to EUREKA


Consul and Eureka are both service discovery tools, but Consul is a more feature-rich, enterprise-grade solution for distributed systems, while Eureka is a simpler tool specifically designed for service discovery and registration, especially within the Spring Cloud ecosystem. Key differences include Consul's decentralized architecture, built-in service mesh capabilities, security features, and support for multi-datacenter environments, compared to Eureka's centralized approach and reliance on integration with other tools for its full functionality.

Service Discovery Pattern: In a dynamic microservices environment, services need a way to find each other. Service Discovery allows services to register themselves and discover other services, often using a registry like Eureka or Consul


PRACTICALS
==========

----------- Setup Service Discovery agent using Eureka Server ----------------


a) New Spring Boot Starter Project - service-registry
Service Discovery agent for our CTS bank microservices
com.cognizant.serviceregistry
Dependencies: Eureka Server,  Actuator

b) on bootstrap class
@EnableEurekaServer    -- converting a normal spring boot project to act as a service discovery agent with the help of eureka libraries present in the Spring Cloud Netflix project


c) in application.properties

spring.application.name=service-registry
server.port=8761
eureka.client.register-with-eureka=false



eureka.client.fetch-registry=false	- not required
eureka.instance.hostname=localhost	- not required

fetchRegistry -> --- we don't want our eureka server to fetch the registry details of other microservices - eureka server never call the microservices 
registerWithEureka: false  --> don't register with yourself


--- application.yml ---
spring:
  application:
    name: service-registry
server:
  port: 8761
eureka:
  client:
    register-with-eureka: false	



Note-1: If "Service-Registry" project port is 8761 then clients can discover service-registry and will register automatically with service-registry. 

Note-2 : If service-registry project running on any other port number other than 8761 - then we have to register clients with service-registry manually using the following property.

     eureka.client.serviceUrl.defaultZone: http://localhost:8761/eureka/


4) Once application started we can access Eureka Dashboard using below URL

		URL : http://localhost:8761/  ----> shows eureka dashboard


PART-2
1) accounts microservice
new dependency : Eureka Discovery Client

--- application.properties ---

server.port: 8080
spring.application.name: accounts


eureka.instance.preferIpAddress: true
eureka.instance.prefer-ip-address: true
eureka.client.fetchRegistry: true
eureka.client.registerWithEureka: true
eureka.client.serviceUrl.defaultZone: http://localhost:8761/eureka/

preferIpAddress --> whenever accounts microservice is trying to register with eureka server -by default it will try to register with hostname; hostnames will make sense whenever you are trying to use DNS mappings inside your microservices network 
  -- accounts microservice will register with eureka server by using the IP address

serviceUrl.defaultZone --> to configure multiple Eureka Servers from Client in Spring Cloud , separate with ,

=====================================
eureka.instance.prefer-ip-address: true
eureka.client.fetchRegistry: true
eureka.client.registerWithEureka: true
eureka.client.serviceUrl.defaultZone: http://localhost:8761/eureka/
=====================================

application.yml

eureka:
  client:
    fetchRegistry: true
    registerWithEureka: true
    serviceUrl:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true



info:
  app:
    name: "accounts"
    description: "CTS Bank Accounts Application"
    version: 1.0.0

the purpose of giving "info" element is - the same information we can see inside eureka dashboard

info.app.name=accounts
info.app.description="Bank Account Application"
info.app.version=1.0.1


management.endpoints.web.exposure.include: *
#management.endpoint.shutdown.enabled: true
management.endpoint.shutdown.access: unrestricted
management.info.env.enabled: true




management:
  endpoints:
    web:
      exposure:
        include: *
  endpoint:
    shutdown:
      enabled: true
  info:
    env:
      enabled: true     


start accounts ms

http://localhost:8761/

GET  http://localhost:8761/eureka/apps/accounts


----------- Make codes changes in Loans & Cards microservice to connect to Eureka Server ----------------
Add "Eureka Discovery Client Dependency" to Loans & Cards microservices

GET  http://localhost:8761/eureka/apps/loans
GET  http://localhost:8761/eureka/apps/cards



----------- De-registration from Eureka server when microservices shutdown ----------------

in accounts microservices - application.properties or in application.yml

management.endpoint.shutdown.access: unrestricted


management:
  endpoints:
    web:
      exposure:
        include: *
  endpoint:
    shutdown:
      enabled: true
  info:
    env:
      enabled: true




POSTMAN - POST --> http://localhost:8080/actuator/shutdown
check in logs of eurekaserver console
check in eureka dashboard



----------- Heartbeats mechanism to Eureka server from clients ----------------

start eureka server, accounts, loans & cards

stop eureka server and check the logs of other microservices - we can see error messages for every 30 seconds -- search for "heartbeat"







